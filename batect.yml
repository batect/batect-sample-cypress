project_name: batect-sample-cypress

containers:
  app:
    image: node:15.0.1
    volumes:
      - local: .
        container: /code
        options: cached
      - type: cache
        name: node_modules
        container: /code/node_modules
    working_directory: /code
    enable_init_process: true
    run_as_current_user:
      enabled: true
      home_directory: /home/container-user
    environment:
      PORT: 8352
    command: npm start

  cypress:
    image: cypress/included:3.4.1
    volumes:
      - local: .
        container: /app
        options: cached
    working_directory: /app

tasks:
  setup:
    description: Download dependencies need to run the application and tests.
    run:
      container: app
      command: npm install

  app:
    description: Start the application (access it at http://localhost:8352)
    run:
      container: app
      ports:
        - 8352:8352

  e2e:
    description: Run the Cypress tests.
    run:
      container: cypress
      command: cypress run --config baseUrl=http://app:8352
    dependencies:
      - app
